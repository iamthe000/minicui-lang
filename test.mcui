# 本格RPG - Advanced Battle System FIXED
# 変数: H:PlayerHP, M:PlayerMP, A:ATK, E:EnemyHP, B:EnemyATK, X:MaxHP
# D:Damage, R:Random, K:Input, S:String

# --- 初期化 ---
SET H 100 # HP
SET M 30  # MP
SET A 15  # 攻撃力
SET E 500 # 敵HPを増加 (## 修正：バランス調整)
SET X 150 # 敵最大HP (現在は未使用)
SET B 10  # 敵攻撃力

# --- メインループ ---
MAIN_LOOP:
    CALL DRAW_UI
    
    CENTER 20 "[1]こうげき [2]ファイア(MP10)"
    CENTER 21 "[3]ヒール(MP15)   [Q]にげる"
    SET S "コマンドを えらんで ください"
    CENTER 23 S 

    KEYWAIT K
    IF K = 'Q' EXIT
    IF K = 'q' EXIT    # ## 修正：小文字の 'q' で終了できるように追加
    IF K = '1' GOTO ACT_ATTACK
    IF K = '2' GOTO ACT_FIRE
    IF K = '3' GOTO ACT_HEAL
    GOTO MAIN_LOOP

# --- プレイヤーアクション ---
ACT_ATTACK:
    SET D A
    RAND R 6
    ADD D R
    
    RAND R 5
    IF R = 0 GOTO CRITICAL
    
    SET S "プレイヤーの こうげき！"
    CALL DAMAGE_E
    GOTO ENEMY_TURN

CRITICAL:
    MUL D 2
    SET S "かいしんの いちげき！！！"
    CALL DAMAGE_E
    GOTO ENEMY_TURN

ACT_FIRE:
    IF M < 10 GOTO NO_MP
    SUB M 10
    
    SET D 30
    RAND R 10
    ADD D R
    
    SET S "ファイアを となえた！"
    CALL DAMAGE_E
    GOTO ENEMY_TURN

ACT_HEAL:
    IF M < 15 GOTO NO_MP
    SUB M 15
    SET R 40
    ADD H R
    IF H > 100 SET H 100 # 最大HPを100に制限
    SET S "ヒール！ HPが かいふくした"
    CALL MSG_WAIT
    GOTO ENEMY_TURN

NO_MP:
    SET S "MPが 足りない！"
    CALL MSG_WAIT
    GOTO MAIN_LOOP

# --- 敵へダメージ適用 ---
FUNC DAMAGE_E
    SUB E D
    CALL DRAW_UI
    CENTER 23 S 
    SLEEP 800
    
    SET S "敵に "
    STRCAT S D
    STRCAT S " のダメージ！"
    CENTER 23 S 
    SLEEP 1000
    
    IF E <= 0 CALL WIN_FUNC
ENDFUNC

# --- 敵のターン ---
ENEMY_TURN:
    IF E > 100 GOTO E_ATTACK_CALC # 敵の行動ロジックを微調整
    RAND R 3
    IF R = 0 GOTO E_HEAL

E_ATTACK_CALC:
    SET D B
    RAND R 8
    ADD D R
    
    SUB H D
    SET S "敵の こうげき！"
    CALL DRAW_UI
    CENTER 23 S
    SLEEP 800
    
    SET S "プレイヤーは "
    STRCAT S D
    STRCAT S " のダメージを うけた！"
    CENTER 23 S 
    SLEEP 1000
    
    IF H <= 0 CALL LOSE_FUNC
    GOTO MAIN_LOOP

E_HEAL:
    ADD E 20
    SET S "敵は 傷を再生している..."
    CALL MSG_WAIT
    GOTO MAIN_LOOP

FUNC MSG_WAIT
    CALL DRAW_UI
    CENTER 23 S 
    SLEEP 1000
ENDFUNC

FUNC DRAW_UI
    CLEAR
    COLOR 34 
    BOX 1 1 78 6
    COLOR 37
    POS 4 2
    PRINT "PLAYER"
    POS 4 3
    PRINT "HP: "
    POS 8 3 
    PRINT H 
    POS 4 4
    PRINT "MP: "
    POS 8 4
    PRINT M 
    POS 50 2
    PRINT "ENEMY (BOSS)"
    POS 50 3
    PRINT "HP: "
    POS 55 3   # ## 修正：表示位置を54から55に変更（HPが3桁以上になったときに重ならないように）
    PRINT E 
    BOX 1 18 78 7
    COLOR 0
ENDFUNC

# --- 勝利/敗北 関数化 ---
FUNC WIN_FUNC
    CLEAR
    COLOR 33
    CENTER 10 "**********************"
    CENTER 11 "* YOU DEFEATED THE  *"
    CENTER 12 "* BOSS!       *"
    CENTER 13 "**********************"
    KEYWAIT K
    EXIT
ENDFUNC

FUNC LOSE_FUNC
    CLEAR
    COLOR 31
    CENTER 12 "GAME OVER..."
    
    # WHILE TEST
    SET C 5
    WHILE C > 0
        POS 1 20
        PRINT "RESTARTING IN "
        POS 15 20
        PRINT C
        SLEEP 500
        SUB C 1
    ENDWHILE

    KEYWAIT K
    EXIT
ENDFUNC
